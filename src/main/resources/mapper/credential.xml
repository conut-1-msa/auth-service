<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.github.conut.msa.auth.domain.credential.dao.CredentialDAO">
    <select id="selectActiveCredentialByUserid">
        SELECT id, user_uuid, userid, password, created_at
        FROM credential
        WHERE userid = #{userid}
        AND status = 'ACTIVE'
    </select>
    <select id="existsByUserid">
        SELECT EXISTS (
            SELECT 1
            FROM credential
            WHERE userid = #{userid}
        )
    </select>
    <insert id="insert">
        INSERT INTO credential (user_uuid, userid, password)
        VALUES (#{userUuid}, #{userid}, #{password})
    </insert>
    <update id="activateCredentialByUserUuid">
        UPDATE credential
        SET status = 'ACTIVE'
        WHERE user_uuid = #{userUuid}
    </update>
    <select id="isActive">
        SELECT EXISTS (
            SELECT 1
            FROM credential
            WHERE user_uuid = #{userUuid}
            AND status = 'ACTIVE'
        )
    </select>
    <update id="failPendingCredentialsWithBatchId">
        UPDATE credential
        SET status = 'FAILED',
            failed_at = NOW(),
            batch_id = #{batchId}
        WHERE status = 'PENDING'
        AND created_at &lt; NOW() - INTERVAL 30 MINUTE
        ORDER BY created_at
        LIMIT 100
    </update>
    <select id="selectByBatchId">
        SELECT user_uuid
        FROM credential
        WHERE batch_id = #{batchId}
    </select>
    <update id="clearBatchId">
        UPDATE credential
        SET batch_id = NULL
        WHERE batch_id = #{batchId}
    </update>
</mapper>
